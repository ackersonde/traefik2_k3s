version: 2.1

jobs:
  build:
    docker:
      - image: google/cloud-sdk:alpine
    working_directory: ~/gke
    steps:
      - add_ssh_keys:
          fingerprints:
            - $CTX_SSH_DEPLOY_FINGERPRINT
      - run:
          name: Store Service Accounts
          command: |
            echo $CTX_GOOGLE_DEPLOY_SERVICE_JSON > ${HOME}/gcloud-service-key.json
            chmod 600 $HOME/gcloud-service-key.json

      - run:
          name: Setup compute instance
          command: |
            gcloud auth activate-service-account --key-file=${HOME}/gcloud-service-key.json
            gcloud --quiet config set project ${CTX_GOOGLE_PROJECT_ID}
            gcloud --quiet config set compute/zone europe-west3-c

            gcloud compute instances create traefik-k3s-$CIRCLE_BUILD_NUM \
              --image-family=debian-10 --image-project=debian-cloud \
              --machine-type=g1-small --boot-disk-size=10GB --boot-disk-type=pd-ssd

            apk -u add jq apache2-utils
            PUBLIC_IP=`gcloud compute instances describe traefik-k3s-$CIRCLE_BUILD_NUM \
              --format=json | jq -r '.networkInterfaces[0].accessConfigs[0].natIP'`
            echo "Public IP is: $PUBLIC_IP"
            echo $PUBLIC_IP > /tmp/public_ip.txt

      - run:
          name: Prepare deploy network access
          command: |
            ORIG_RANGE=`gcloud compute firewall-rules describe default-allow-ssh \
              --format=json | jq -r '.sourceRanges | @csv'`
            ORIG_RANGE=`echo ${ORIG_RANGE//\"}`
            echo $ORIG_RANGE > /tmp/orig_range.txt

            export DEPLOY_IP=`curl -s https://icanhazip.com`
            gcloud compute firewall-rules update default-allow-ssh \
              --source-ranges=$ORIG_RANGE,$DEPLOY_IP

      - checkout
      - run:
          name: Install K3S & prep K8S configs
          command: |
            export PUBLIC_IP=`cat /tmp/public_ip.txt`

            chmod 600 *.yml

            # ensure GCE instance is fully up & ready for SSH connections
            sleep 10

            htpasswd -cb .htpasswd $CTX_BASIC_AUTH_USER $CTX_BASIC_AUTH_PASSWD
            base64 .htpasswd | tr -d \\n > .base64_enc
            export HTPASSWD_B64=`cat .base64_enc`
            sed -i -e "s@{{HTPASSWD_B64}}@$HTPASSWD_B64@" 02-svcs-middleware-secrets.yml

            export INTERNAL_HOST_IP=`gcloud compute instances describe traefik-k3s-$CIRCLE_BUILD_NUM --format=json | jq -r '.networkInterfaces[0].networkIP'`
            sed -i -e "s@{{INTERNAL_HOST_IP}}@$INTERNAL_HOST_IP@" 02-svcs-middleware-secrets.yml

            echo -n "$CTX_DIGITALOCEAN_TOKEN" | base64 | tr -d \\n > .base64_enc
            export CTX_DIGITALOCEAN_TOKEN_B64=`cat .base64_enc`
            sed -i -e "s@{{CTX_DIGITALOCEAN_TOKEN_B64}}@$CTX_DIGITALOCEAN_TOKEN_B64@" 02-svcs-middleware-secrets.yml

            echo -n "$CTX_DATADOG_API_KEY" | base64 | tr -d \\n > .base64_enc
            export CTX_DATADOG_API_KEY_B64=`cat .base64_enc`
            sed -i -e "s@{{CTX_DATADOG_API_KEY_B64}}@$CTX_DATADOG_API_KEY_B64@" datadog-agent.yml

            rm .base64_enc
            scp -o StrictHostKeyChecking=no -r *.yml ackersond@$PUBLIC_IP:~/
            ssh ackersond@$PUBLIC_IP -- "curl -sfL https://get.k3s.io | \
              sh -s - server --no-deploy traefik --no-deploy servicelb"

      - run:
          name: Install CRDs for Traefik, Docker registry creds & launch Traefik
          command: |
            export PUBLIC_IP=`cat /tmp/public_ip.txt`

            ssh ackersond@$PUBLIC_IP -- "sudo kubectl apply -f 01-clusterrole-CRDs.yml &&
              sudo kubectl apply -f 02-svcs-middleware-secrets.yml &&
              sudo kubectl apply -f 03-deployments.yml &&
              sudo kubectl apply -f 04-ingressroutes.yml &&
              sudo kubectl create secret docker-registry dockerhub \
              --docker-server=https://index.docker.io/v1/ \
              --docker-username=$CTX_DOCKER_USER \
              --docker-password=$CTX_DOCKER_PASS \
              --docker-email=dan@ackerson.de &&
              echo \"alias k='sudo kubectl'\" >> .bashrc &&
              sudo kubectl create -f https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrole.yaml &&
              sudo kubectl create -f https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/serviceaccount.yaml &&
              sudo kubectl create -f https://raw.githubusercontent.com/DataDog/datadog-agent/master/Dockerfiles/manifests/rbac/clusterrolebinding.yaml"

      - run:
          name: Update DNS entries of apigcp & k3sgcp
          command: |
            export PUBLIC_IP=`cat /tmp/public_ip.txt`
            #curl -X GET -H "Content-Type: application/json" -H "Authorization: Bearer $CTX_DIGITALOCEAN_TOKEN" \
            #  "https://api.digitalocean.com/v2/domains/ackerson.de/records?page=2"

            curl --silent -X PUT -H "Content-Type: application/json" \
              -H "Authorization: Bearer $CTX_DIGITALOCEAN_TOKEN" -d "{\"data\":\"$PUBLIC_IP\"}" \
              "https://api.digitalocean.com/v2/domains/ackerson.de/records/83995585"
            curl --silent -X PUT -H "Content-Type: application/json" \
              -H "Authorization: Bearer $CTX_DIGITALOCEAN_TOKEN" -d "{\"data\":\"$PUBLIC_IP\"}" \
              "https://api.digitalocean.com/v2/domains/ackerson.de/records/83995576"

      - run:
          name: Remove deploy network access
          command: |
            export ORIG_RANGE=`cat /tmp/orig_range.txt`
            if [ ! -z "$ORIG_RANGE" ]; then
              gcloud compute firewall-rules update default-allow-ssh \
                --source-ranges=$ORIG_RANGE
            fi
          when: always

workflows:
  build:
    jobs:
        - build:
            context: org-global
